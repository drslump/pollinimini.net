<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Pollinimini.net</title>
     
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="Iván -DrSlump- Montes" />
    <meta name="description" content="DrSlump @ Pollinimini.net" />

    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
     
    
    <link rel="stylesheet" href="/resources/global.css" type="text/css" />
    
     
    
  </head>
  <body>
    <!--[if lt IE 8]>
    <div style='border: 1px solid #F7941D; background: #FEEFDA; text-align: center; clear: both; height: 75px; position: relative;'>
    <div style='position: absolute; right: 3px; top: 3px; font-family: courier new; font-weight: bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border: none;' alt='Close this notice'/></a></div>
    <div style='width: 640px; margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black;'>
      <div style='width: 75px; float: left;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/></div>
      <div style='width: 275px; float: left; font-family: Arial, sans-serif;'>
        <div style='font-size: 14px; font-weight: bold; margin-top: 12px;'>You are using an outdated browser</div>
        <div style='font-size: 12px; margin-top: 6px; line-height: 12px;'>For a better experience using this site, please upgrade to a modern web browser.</div>
      </div>
      <div style='width: 75px; float: left;'><a href='http://www.firefox.com' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border: none;' alt='Get Firefox 3.5'/></a></div>
      <div style='width: 75px; float: left;'><a href='http://www.browserforthebetter.com/download.html' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border: none;' alt='Get Internet Explorer 8'/></a></div>
      <div style='width: 73px; float: left;'><a href='http://www.apple.com/safari/download/' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border: none;' alt='Get Safari 4'/></a></div>
      <div style='float: left;'><a href='http://www.google.com/chrome' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border: none;' alt='Get Google Chrome'/></a></div>
    </div>
    </div>
    <![endif]-->

    <div id="header">
      <h1>
        <a href="/">Pollinimini.net</a>        
      </h1>
    </div>

    <ul id="navigation">
    
      <li>
        <a  href="/" >Blog</a>
        
      </li>
    
      <li>
        <a  href="/about/" >About</a>
        
          <ul>
          
            <li>
              <a  href="/portfolio/" >Portfolio</a>
            </li>
          
            <li>
              <a  href="mailto:drslump-at-pollinimini-dot-net" >Contact</a>
            </li>
          
          </ul>
        
      </li>
    
    </ul>
      
    <div id="body">
      <a name="content" class="hidden">Skip to content</a>
      <div id="sidebar">
        
            <p class="about">
    <a href="/about">
        <img src="/resources/meatduck.png" width="80" height="80" alt="Avatar" />
    </a>
    Hi, I'm Iván Montes, also known as DrSlump, a passionate web developer.
    You can follow me on <a href="/atom.xml">this blog</a>, fork me on 
    <a href="http://github.com/drslump">GitHub</a> and check out some of my
    work on my <a href="/portfolio">portfolio</a>.
</p>

<a class="twitter-timeline" data-dnt="true" href="https://twitter.com/DrSlump" data-widget-id="399685000380952576">Tweets by @DrSlump</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

        
      </div>

      <div id="content">
        
  <div class="entry">
  <h2>
    
    <a href="/blog/zend-framework-inlinescript-helper-hack">Zend Framework InlineScript helper hack</a>
    
  </h2>
   
  <div class="entry-meta">
    Feb 08, 2011
    — Filled in Code
    
      and tagged as
      php and zendframework
    

    <a class="entry-comments" href="/blog/zend-framework-inlinescript-helper-hack/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <blockquote>
<p>Pepe -_blacky_- Jiménez has been kind enough to act as special guest in this blog and write about a <em>hack</em> he found, when including Javascript chunks into PHP files, while using <a href='http://framework.zend.com'>Zend Framework</a>&#8217;s <a href='http://framework.zend.com/manual/en/zend.view.helpers.html#zend.view.helpers.initial.inlinescript'>InlineScript</a> view helper.</p>

<p>If you are looking for a talented web frontend programmer I can only speak good words about this bloke.</p>
</blockquote>

<h2 id='why_this_hack'>Why this hack?</h2>

<p>Syntax highlighting is essential for developers. If you are familiar with <a href='http://framework.zend.com'>Zend Framework</a> you will know that <a href='http://framework.zend.com/manual/en/zend.view.helpers.html#zend.view.helpers.initial.inlinescript'>InlineScript</a> view helper doesn&#8217;t need the <code>&lt;script&gt;</code> tag. The reason is simple, that tag is automatically included at the view rendering stage. There is one big disadvantage however when you are developing in your favorite IDE&#8230; No syntax highlighting for your JavaScript piece of code.</p>

<p>When I noticed that, I searched for a solution at Google. No luck this time&#8230; So I started thinking how to solve this issue. As far as I know, IDEs detect JavaScript language in source files thanks to the <code>&lt;script&gt;</code> tag, so that should be a good start. If we could find a way to keep the tag in the source file and remove it before rendering it the problem would disappear.</p>

<h2 id='how_it_works'>How it works?</h2>

<p>The <a href='http://framework.zend.com/manual/en/zend.view.helpers.html#zend.view.helpers.initial.inlinescript'>InlineScript</a> inherits from <a href='http://framework.zend.com/manual/en/zend.view.helpers.html#zend.view.helpers.initial.headscript'>HeadScript</a> who is responsible for introducing JavaScript content (literal source code or file). Taking a look at the <a href='http://framework.zend.com/manual/en/zend.view.helpers.html#zend.view.helpers.initial.headscript'>HeadScript</a> <code>__call</code> method, the <code>createData</code> function is the best candidate to solve this tag issue. If we look at Zend Framework&#8217;s source code, the 3rd parameter is the one containing our JavaScript code (potentially including the <code>&lt;script&gt;</code> tag).</p>

<p>Once we have this function located is very easy to remove the <code>&lt;script&gt;</code> tag. We just need to create a custom view helper extending Zend Framework&#8217;s one in order to override the <code>createData</code> method. At this point take a look at the source code below to see how it works.</p>

<p>I hope this post will prove useful to other developers who have been in the same situation as me.</p>

<blockquote>
<p>Note: Don&#8217;t forget that custom view helpers prefix and paths have to be properly configured in your application to be automatically loaded and used.</p>
</blockquote>

<h2 id='code'>Code</h2>
<div class='highlight'><pre><code class='php'><span class='x'>    </span><span class='cp'>&lt;?php</span>
    <span class='sd'>/**</span>
<span class='sd'>     * Remove &lt;script&gt; tags</span>
<span class='sd'>     *</span>
<span class='sd'>     * @author      Jose Luis Jiménez &lt;jljc.work@gmail.com&gt;</span>
<span class='sd'>     */</span>
    <span class='k'>class</span> <span class='nc'>Pepe_Zend_View_Helper_InlineScript</span> <span class='k'>extends</span> <span class='nx'>Zend_View_Helper_InlineScript</span>
    <span class='p'>{</span>
      <span class='sd'>/**</span>
<span class='sd'>       * Create data item containing all necessary components of script</span>
<span class='sd'>       *</span>
<span class='sd'>       * @param  string $type</span>
<span class='sd'>       * @param  array $attributes</span>
<span class='sd'>       * @param  string $content</span>
<span class='sd'>       * @return stdClass</span>
<span class='sd'>       */</span>
      <span class='k'>public</span> <span class='k'>function</span> <span class='nf'>createData</span><span class='p'>(</span><span class='nv'>$type</span><span class='p'>,</span> <span class='k'>array</span> <span class='nv'>$attributes</span><span class='p'>,</span> <span class='nv'>$content</span> <span class='o'>=</span> <span class='k'>null</span><span class='p'>)</span>
      <span class='p'>{</span>
        <span class='c1'>// Replace &lt;script&gt; tag</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='k'>empty</span><span class='p'>(</span><span class='nv'>$content</span><span class='p'>))</span> <span class='p'>{</span>
          <span class='nv'>$content</span> <span class='o'>=</span> <span class='nb'>preg_replace</span><span class='p'>(</span><span class='s1'>&#39;@^\s*&lt;script[^&gt;]*&gt;@i&#39;</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>,</span> <span class='nv'>$content</span><span class='p'>);</span>
          <span class='nv'>$content</span> <span class='o'>=</span> <span class='nb'>preg_replace</span><span class='p'>(</span><span class='s1'>&#39;@&lt;/script&gt;\s*$@i&#39;</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>,</span> <span class='nv'>$content</span><span class='p'>);</span>
        <span class='p'>}</span>

        <span class='c1'>// Call parent</span>
        <span class='k'>return</span> <span class='k'>parent</span><span class='o'>::</span><span class='na'>createData</span><span class='p'>(</span><span class='nv'>$type</span><span class='p'>,</span> <span class='nv'>$attributes</span><span class='p'>,</span> <span class='nv'>$content</span><span class='p'>);</span>
      <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre></div>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 

  <div class="entry">
  <h2>
    
    <a href="/blog/php-post-max-size">PHP post_max_size issue</a>
    
  </h2>
   
  <div class="entry-meta">
    Aug 03, 2010
    — Filled in Code
    
      and tagged as
      php, upload, and ini
    

    <a class="entry-comments" href="/blog/php-post-max-size/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>PHP&#8217;s ability to manage uploaded files has always left mixing feelings in me, on one hand it&#8217;s really trivial to implement file upload functionality on PHP scripts but in the other, managing big files uploads (just anything above a couple megabytes) is far from reliable.</p>

<p>Recently a couple solutions became popular to implement <em>progressive uploads</em> in PHP, <a href='http://pecl.php.net/package/uploadprogress'>PECL&#8217;s uploadprogress extension</a> and recent <a href='http://www.php.net/manual/es/apc.configuration.php#ini.apc.rfc1867'>APC</a> versions. But anyway, the default PHP behaviour when uploading a file is to wait until it&#8217;s been fully transferred to the server before executing the php script.</p>

<p>This design decision from the PHP folks greatly simplifies the most common case, since you always get the full file when your PHP code runs, but also means that <em>big</em> files can cause some serious trouble. To defend itself, PHP has a few ini options that tune its ability to work with big files.</p>

<p><code>upload_max_filesize</code> tells PHP the maximum size an uploaded file can have, files bigger will be reported as an error in the <code>$_FILES</code> array. <code>max_input_time</code> control the maximum time PHP can spend receiving data from the client, this is important because if you have many visitors with slow connections (or a malevolent attacker) a lot of PHP processes will be idling in memory collecting data slowly, consuming your server resources and potentially provoking your server to become unresponsive. Finally, we have <code>post_max_size</code>, which is a bit tricky, it limits the maximum amount of data a request from the client can hold. The tricky part is that if that limit is reached PHP won&#8217;t error out or signal the problem anyhow to your script, instead it will continue normal script execution but won&#8217;t populate <code>$_POST</code> or <code>$_FILES</code> superglobals, leaving them empty.</p>

<p>So if your <code>post_max_size</code> is set to 2Mb and a client uploads a 3Mb file, nor <code>$_POST</code> neither <code>$_FILES</code> will have any content. Even if you set your <code>upload_max_filesize</code> to 2Mb or below, if size of the file (or files) is bigger you will find yourself with those superglobals empty.</p>

<p>There is however a way to detect this condition, like shown in the following code snippet.</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>

<span class='k'>if</span> <span class='p'>(</span><span class='nb'>in_array</span><span class='p'>(</span><span class='nv'>$_SERVER</span><span class='p'>[</span><span class='s1'>&#39;REQUEST_METHOD&#39;</span><span class='p'>],</span> <span class='k'>array</span><span class='p'>(</span><span class='s1'>&#39;POST&#39;</span><span class='p'>,</span> <span class='s1'>&#39;PUT&#39;</span><span class='p'>)))</span> <span class='p'>{</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='k'>empty</span><span class='p'>(</span><span class='nv'>$_POST</span><span class='p'>)</span> <span class='o'>&amp;&amp;</span> <span class='k'>empty</span><span class='p'>(</span><span class='nv'>$_FILES</span><span class='p'>))</span> <span class='p'>{</span>

    <span class='c1'>// Get maximum size and meassurement unit</span>
    <span class='nv'>$max</span> <span class='o'>=</span> <span class='nb'>ini_get</span><span class='p'>(</span><span class='s1'>&#39;post_max_size&#39;</span><span class='p'>);</span>
    <span class='nv'>$unit</span> <span class='o'>=</span> <span class='nx'>substr</span><span class='p'>(</span><span class='nv'>$max</span><span class='p'>,</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>);</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='nb'>is_numeric</span><span class='p'>(</span><span class='nv'>$unit</span><span class='p'>))</span> <span class='p'>{</span>
      <span class='nv'>$max</span> <span class='o'>=</span> <span class='nx'>substr</span><span class='p'>(</span><span class='nv'>$max</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>);</span>
    <span class='p'>}</span>

    <span class='c1'>// Convert to bytes</span>
    <span class='k'>switch</span> <span class='p'>(</span><span class='nx'>strtoupper</span><span class='p'>(</span><span class='nv'>$unit</span><span class='p'>))</span> <span class='p'>{</span>
      <span class='k'>case</span> <span class='s1'>&#39;G&#39;</span><span class='o'>:</span>
        <span class='nv'>$max</span> <span class='o'>*=</span> <span class='mi'>1024</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='s1'>&#39;M&#39;</span><span class='o'>:</span>
        <span class='nv'>$max</span> <span class='o'>*=</span> <span class='mi'>1024</span><span class='p'>;</span>
      <span class='k'>case</span> <span class='s1'>&#39;K&#39;</span><span class='o'>:</span>
        <span class='nv'>$max</span> <span class='o'>*=</span> <span class='mi'>1024</span><span class='p'>;</span>
    <span class='p'>}</span>

    <span class='c1'>// Assert the content length is within limits</span>
    <span class='nv'>$length</span> <span class='o'>=</span> <span class='nv'>$_SERVER</span><span class='p'>[</span><span class='s1'>&#39;CONTENT_LENGTH&#39;</span><span class='p'>];</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$max</span> <span class='o'>&lt;</span> <span class='nv'>$length</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='k'>throw</span> <span class='k'>new</span> <span class='nx'>Exception</span><span class='p'>(</span><span class='s1'>&#39;Maximum content length size (&#39;</span> <span class='o'>.</span> <span class='nv'>$max</span> <span class='o'>.</span> <span class='s1'>&#39;) exceeded&#39;</span><span class='p'>);</span>
    <span class='p'>}</span>
  <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>
<p>With that code in place you can gracely detect the issue and act accordingly by showing the user an error page explaining what just happened for example.</p>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 

  <div class="entry">
  <h2>
    
    <a href="/blog/php-command-runner">PHP command runner class</a>
    
  </h2>
   
  <div class="entry-meta">
    May 31, 2010
    — Filled in Code
    
      and tagged as
      php, shell, command, and proc_open
    

    <a class="entry-comments" href="/blog/php-command-runner/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>PHP offers <a href='http://php.net/exec'>multiple methods to execute external applications</a>, for simple things they are more than enough but sometimes we need more flexibility. The following class acts as a wrapper around <a href='http://php.net/proc_open'>proc_open</a>.</p>

<p>It implements a <em>fluent interface</em> to ease its configuration and non-blocking pipes for stdout and stderr. The output can be obtained at the end of the program execution or incrementally by using a callback function.</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
<span class='nv'>$cmd</span> <span class='o'>=</span> <span class='nx'>Command</span><span class='o'>::</span><span class='na'>factory</span><span class='p'>(</span><span class='s1'>&#39;/usr/bin/svn&#39;</span><span class='p'>);</span>
<span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>option</span><span class='p'>(</span><span class='s1'>&#39;--username&#39;</span><span class='p'>,</span> <span class='s1'>&#39;drslump&#39;</span><span class='p'>)</span>
    <span class='o'>-&gt;</span><span class='na'>option</span><span class='p'>(</span><span class='s1'>&#39;-r&#39;</span><span class='p'>,</span> <span class='s1'>&#39;HEAD&#39;</span><span class='p'>)</span>
    <span class='o'>-&gt;</span><span class='na'>option</span><span class='p'>(</span><span class='s1'>&#39;log&#39;</span><span class='p'>)</span>
    <span class='o'>-&gt;</span><span class='na'>argument</span><span class='p'>(</span><span class='s1'>&#39;http://code.google.com/drslump/trunk&#39;</span><span class='p'>);</span>
    <span class='o'>-&gt;</span><span class='na'>run</span><span class='p'>();</span>
<span class='k'>if</span> <span class='p'>(</span><span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>getExitCode</span><span class='p'>()</span> <span class='o'>===</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>echo</span> <span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>getStdOut</span><span class='p'>();</span>
<span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
    <span class='k'>echo</span> <span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>getStdErr</span><span class='p'>();</span>
<span class='p'>}</span>
</code></pre></div>
<p>Incremental updates can be accomplished with a callback function, like in the following example (PHP 5.3+):</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
<span class='nv'>$cmd</span> <span class='o'>=</span> <span class='nx'>Command</span><span class='o'>::</span><span class='na'>factory</span><span class='p'>(</span><span class='s1'>&#39;ls&#39;</span><span class='p'>);</span>
<span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>setCallback</span><span class='p'>(</span><span class='k'>function</span><span class='p'>(</span><span class='nv'>$pipe</span><span class='p'>,</span> <span class='nv'>$data</span><span class='p'>){</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$pipe</span> <span class='o'>===</span> <span class='nx'>Command</span><span class='o'>::</span><span class='na'>STDOUT</span><span class='p'>)</span> <span class='k'>echo</span> <span class='s1'>&#39;STDOUT: &#39;</span><span class='p'>;</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$pipe</span> <span class='o'>===</span> <span class='nx'>Command</span><span class='o'>::</span><span class='na'>STDERR</span><span class='p'>)</span> <span class='k'>echo</span> <span class='s1'>&#39;STDERR: &#39;</span><span class='p'>;</span>
        <span class='k'>echo</span> <span class='nv'>$data</span> <span class='o'>===</span> <span class='k'>NULL</span> <span class='o'>?</span> <span class='s2'>&quot;EOF</span><span class='se'>\n</span><span class='s2'>&quot;</span> <span class='o'>:</span> <span class='s2'>&quot;</span><span class='si'>$data</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>;</span>
        <span class='c1'>// If we return &quot;false&quot; all pipes will be closed</span>
        <span class='c1'>// return false;</span>
    <span class='p'>})</span>
    <span class='o'>-&gt;</span><span class='na'>setDirectory</span><span class='p'>(</span><span class='s1'>&#39;/tmp&#39;</span><span class='p'>)</span>
    <span class='o'>-&gt;</span><span class='na'>option</span><span class='p'>(</span><span class='s1'>&#39;-l&#39;</span><span class='p'>)</span>
    <span class='o'>-&gt;</span><span class='na'>run</span><span class='p'>();</span>
<span class='k'>if</span> <span class='p'>(</span><span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>getExitCode</span><span class='p'>()</span> <span class='o'>===</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>echo</span> <span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>getStdOut</span><span class='p'>();</span>
<span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
    <span class='k'>echo</span> <span class='nv'>$cmd</span><span class='o'>-&gt;</span><span class='na'>getStdErr</span><span class='p'>();</span>
<span class='p'>}</span>
</code></pre></div>
<p>Some more features:</p>

<ul>
<li>StdIn data can be provided to the process as a parameter to <code>run()</code></li>

<li>Set environment variables for the process with <code>setEnv()</code></li>

<li>Second argument to <code>option()</code> and argument to <code>argument()</code> are automatically escaped.</li>

<li>Options separator is white space by default, it can be changed by manually setting it as third argument to <code>option()</code> or setting a new default with <code>setOptionSeparator()</code>.</li>

<li>The <code>proc_open</code> wrapper is exposed as a static method for your convenience <code>Command::exec()</code></li>
</ul>

<p>And finally the class which makes all that possible :)</p>
<script src='http://gist.github.com/420268.js?file=Command.php'>.</script>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 

  <div class="entry">
  <h2>
    
    <a href="/blog/svnsync-postcommit">Subversion svnsync post-commit hook work around</a>
    
  </h2>
   
  <div class="entry-meta">
    May 11, 2010
    — Filled in Code
    
      and tagged as
      subversion and svn
    

    <a class="entry-comments" href="/blog/svnsync-postcommit/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>Just a quickie for future reference. Svnsync is a tool that comes with Subversion that allows to create read-only mirrors of Subversion repositories.</p>

<p>Creating a mirror is quite easy and usually involves the following steps:</p>

<ul>
<li>
<p>First we create a standard subversion repository.</p>

<pre><code> mkdir mirror
 svnadmin create mirror</code></pre>
</li>

<li>
<p>Now we have to create a pre-revprop-change hook that only allows the <em>svnsync</em> write access to it. Remember that the mirror is read-only. Put the following contents in <code>mirror/hooks/pre-revprop-change</code>.</p>

<pre><code> #!/bin/sh

 if [ &quot;$3&quot; = &quot;svnsync&quot; ]; then exit 0; fi
 echo &quot;Only svnsync user may edit revision properties through svnsync&quot; &gt;&amp;2
 exit 1</code></pre>
</li>

<li>
<p>To activate the hook we need to give it executable permissions.</p>

<pre><code> chmod +x mirror/hooks/pre-revprop-change</code></pre>
</li>

<li>
<p>Configure the synchronization</p>

<pre><code> svnsync init --username svnsync \
     file:///path/to/mirror \
     https://url.to/repository</code></pre>
</li>

<li>
<p>Finally perform the synchronization! You can put this command in the cron system for example to ensure the mirror is kept up-to-date.</p>

<pre><code> svnsync sync file:///path/to/mirror</code></pre>
</li>
</ul>

<p>There is a problem though with this setup if we want to use a <em>post-commit hook</em>. <em>svnsync</em> works by first committing a synced revision with its own user and then, in a second step, modifies the revision properties to change the author and date to those of the original repository. This means that <em>post-commit</em> hooks which need to obtain the revision author or date cannot be property run, since the reported author and date will be wrong.</p>

<p>The solution is to use a different hook, <em>post-revprop-change</em>, which is triggered each time a revision property is changed. We can have something as the following script to emulate a normal <em>post-commit</em> hook.</p>
<div class='highlight'><pre><code class='sh'>  <span class='c'>#!/bin/sh</span>

  <span class='nv'>REPOS</span><span class='o'>=</span><span class='s2'>&quot;$1&quot;</span>
  <span class='nv'>REV</span><span class='o'>=</span><span class='s2'>&quot;$2&quot;</span>
  <span class='nv'>USER</span><span class='o'>=</span><span class='s2'>&quot;$3&quot;</span>
  <span class='nv'>PROPNAME</span><span class='o'>=</span><span class='s2'>&quot;$4&quot;</span>
  <span class='nv'>ACTION</span><span class='o'>=</span><span class='s2'>&quot;$5&quot;</span>

  <span class='c'># Only do actual work when the &quot;svn:date&quot; property is modified, which seems</span>
  <span class='c'># to be the last revision property modified by the svnsync process.</span>
  <span class='k'>if</span> <span class='o'>[</span> <span class='s2'>&quot;$ACTION&quot;</span> <span class='o'>=</span> <span class='s2'>&quot;M&quot;</span> -a <span class='s2'>&quot;$PROPNAME&quot;</span> <span class='o'>=</span> <span class='s2'>&quot;svn:date&quot;</span> <span class='o'>]</span><span class='p'>;</span> <span class='k'>then</span>
<span class='k'>    </span><span class='nv'>AUTHOR</span><span class='o'>=</span><span class='sb'>`</span>svnlook author <span class='nv'>$REPOS</span> -r <span class='nv'>$REV</span><span class='sb'>`</span>
    <span class='nv'>DATE</span><span class='o'>=</span><span class='sb'>`</span>svnlook date <span class='nv'>$REPOS</span> -r <span class='nv'>$REV</span><span class='sb'>`</span>
    <span class='nv'>LOG</span><span class='o'>=</span><span class='sb'>`</span>svnlook log <span class='nv'>$REPOS</span> -r <span class='nv'>$REV</span><span class='sb'>`</span>

    <span class='nb'>echo</span> <span class='s2'>&quot;$REPOS@$REV: $LOG by $AUTHOR at $DATE&quot;</span>
  <span class='k'>fi</span>
  
</code></pre></div>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 




  <div id="pagination">
    
  
    
      
        <span class="num">1</span>
      
    
      
        <a class="num" href="/page2/">2</a>
      
    
      
        <a class="num" href="/page3/">3</a>
      
    
      
        <a class="num" href="/page4/">4</a>
      
    
      
        <a class="num" href="/page5/">5</a>
      
    
      
        <a class="num" href="/page6/">6</a>
      
    
      
        <a class="num" href="/page7/">7</a>
      
    
      
        <a class="num" href="/page8/">8</a>
      
    
      
        <a class="num" href="/page9/">9</a>
      
    
      
        <a class="num" href="/page10/">10</a>
      
    
      
        <a class="num" href="/page11/">11</a>
      
    
      
        <a class="num" href="/page12/">12</a>
      
    
  
    
      <a class="next" href="/page2/">Older &raquo;</a>
    
  </div>



      </div>       
    </div>
     
    <div id="footer">
      <div id="about">
        
        <p>Content is licensed under <a href="http://creativecommons.org/licenses/by/2.5/">Creative Commons Attribution 2.5</a> unless stated otherwise.
</p>
        
        <p>The opinions of authors expressed herein are those of the author and do not necessarily state or reflect those of the site owner.
</p>
        
      </div>
      <div id="copyright">
        
        <p>&copy; Copyright 2004-2010 Iván -DrSlump- Montes</p>
        
        <p>Design based on <a href="http://dezinerfolio.com/demo/darkelegance">Dark Elegance</a> by <a href="http://dezinerfolio.com">Dezinerfolio</a>
</p>
        
        <p>Published with <a href="http://jekyllrb.com">Jekyll</a></p>
        
      </div>
    </div>
     
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    
     
    

    <!-- Disqus number of comments -->
    <script type="text/javascript" defer="defer">
      (function(){
        var links = document.getElementsByTagName('a');
        var query = '?';
        for (var i=0; i<links.length; i++){
          if (links[i].href.indexOf('#disqus_thread') >= 0){
            query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
        }
        document.write('<script defer="defer" charset="utf-8" type="text/javascript" src="http://disqus.com/forums/pollinimini/get_num_replies.js' + query + '"></' + 'script>');
      })();
    </script>

    <!-- Google Analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-580032-2");
      pageTracker._trackPageview();
    } catch(err) {}
    </script>
    
  </body>
</html>
