<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Pollinimini.net</title>
     
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="Iván -DrSlump- Montes" />
    <meta name="description" content="DrSlump @ Pollinimini.net" />

    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
     
    
    <link rel="stylesheet" href="/resources/global.css" type="text/css" />
    
     
    
  </head>
  <body>
    <!--[if lt IE 8]>
    <div style='border: 1px solid #F7941D; background: #FEEFDA; text-align: center; clear: both; height: 75px; position: relative;'>
    <div style='position: absolute; right: 3px; top: 3px; font-family: courier new; font-weight: bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border: none;' alt='Close this notice'/></a></div>
    <div style='width: 640px; margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black;'>
      <div style='width: 75px; float: left;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/></div>
      <div style='width: 275px; float: left; font-family: Arial, sans-serif;'>
        <div style='font-size: 14px; font-weight: bold; margin-top: 12px;'>You are using an outdated browser</div>
        <div style='font-size: 12px; margin-top: 6px; line-height: 12px;'>For a better experience using this site, please upgrade to a modern web browser.</div>
      </div>
      <div style='width: 75px; float: left;'><a href='http://www.firefox.com' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border: none;' alt='Get Firefox 3.5'/></a></div>
      <div style='width: 75px; float: left;'><a href='http://www.browserforthebetter.com/download.html' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border: none;' alt='Get Internet Explorer 8'/></a></div>
      <div style='width: 73px; float: left;'><a href='http://www.apple.com/safari/download/' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border: none;' alt='Get Safari 4'/></a></div>
      <div style='float: left;'><a href='http://www.google.com/chrome' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border: none;' alt='Get Google Chrome'/></a></div>
    </div>
    </div>
    <![endif]-->

    <div id="header">
      <h1>
        <a href="/">Pollinimini.net</a>        
      </h1>
    </div>

    <ul id="navigation">
    
      <li>
        <a  href="/" >Blog</a>
        
      </li>
    
      <li>
        <a  href="/about/" >About</a>
        
          <ul>
          
            <li>
              <a  href="/portfolio/" >Portfolio</a>
            </li>
          
            <li>
              <a  href="mailto:drslump-at-pollinimini-dot-net" >Contact</a>
            </li>
          
          </ul>
        
      </li>
    
    </ul>
      
    <div id="body">
      <a name="content" class="hidden">Skip to content</a>
      <div id="sidebar">
        
            <p class="about">
    <a href="/about">
        <img src="/resources/meatduck.png" width="80" height="80" alt="Avatar" />
    </a>
    Hi, I'm Iván Montes, also known as DrSlump, a passionate web developer.
    You can follow me on <a href="/atom.xml">this blog</a>, fork me on 
    <a href="http://github.com/drslump">GitHub</a> and check out some of my
    work on my <a href="/portfolio">portfolio</a>.
</p>

<a class="twitter-timeline" data-dnt="true" href="https://twitter.com/DrSlump" data-widget-id="399685000380952576">Tweets by @DrSlump</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

        
      </div>

      <div id="content">
        
  <div class="entry">
  <h2>
    
    <a href="/blog/interfacing-odbc-linux">Interfacing ODBC from Linux</a>
    
  </h2>
   
  <div class="entry-meta">
    Jun 02, 2006
    — Filled in Code
    
      and tagged as
      odbc and php
    

    <a class="entry-comments" href="/blog/interfacing-odbc-linux/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>Our billing software runs on Windows platforms and uses ODBC to store its data. Recently we called the makers of that software since we wanted to extract some Business Intelligence from our records.</p>

<p>It turned out that they where going to release a new program for that purpose. We asked to evaluate the beta version and to my surprise it just created an Microsoft Excel file with a dynamic table report.</p>

<p>So I worked on the needed SQL query to extract the records we wanted and exported the data into a CSV to be loaded in an Excel worksheet with a dynamic table report. It worked ok, however the sales and marketting people didn’t want to contact a technician every time they needed the reports to be updated.</p>

<p>The problem was that our application server is a Debian box and since we didn’t have to much time to expend on this, we looked for the easiest solution. I found <a href='http://odbcsock.sourceforge.net/'>ODBC Socket Server</a> which seems unmaintained but the last version works ok on our Windows Server 2003 machine. It’s a service which acts as a proxy for ODBC databases in the local machine, so they can be accessed from other machines using a socket connection and a very simple XML grammar. Once everything was in place I wrote a simple PHP program to fetch the needed records (a few thousand rows). To my surprise the available PHP libraries to interact with ODBC Socket Server didn’t perform too well. They stored the full response in memory and then build up an array, since we need a few thousend rows, the amount of memory required was too high for our little Debian system.</p>

<p>The following code is a pretty simple set of classes to work with ODBC Socket Server. They fetch the data on demand, using a SAX type xml parser to discard the already processed records. It’s not a really thought of or tested solution, however I’m making it public since it’s far better than existing solutions.</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
<span class='cm'>/*</span>
<span class='cm'>  The ODBCSock class is an utility object to operate with the ODBC Socket Server</span>
<span class='cm'>  from http://odbcsock.sourceforge.net</span>

<span class='cm'>  It&#39;s compatible with ODBC Socket Server&#39;s XML formats 0 and 2. In our tests</span>
<span class='cm'>  xml format 2 is significally faster than the others.</span>
<span class='cm'>  Should run on PHP4 and PHP5, however it&#39;s only been tested on PHP5</span>

<span class='cm'>  This code is copyright (c) 2006 Netxus Foundries</span>
<span class='cm'>  v1.0 28-May-2006 : Ivan -DrSlump- Montes &lt;imontes@netxus.es&gt;</span>

<span class='cm'>  This program is free software; you can redistribute it and/or modify</span>
<span class='cm'>  it under the terms of the GNU General Public License as published by</span>
<span class='cm'>  the Free Software Foundation; either version 2 of the License, or</span>
<span class='cm'>  (at your option) any later version.</span>

<span class='cm'>  This program is distributed in the hope that it will be useful, but</span>
<span class='cm'>  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class='cm'>  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<span class='cm'>  for more details.</span>
<span class='cm'>  You should have received a copy of the GNU General Public License along</span>
<span class='cm'>  with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class='cm'>  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA</span>
<span class='cm'>*/</span>

<span class='k'>class</span> <span class='nc'>ODBCSock</span> <span class='p'>{</span>
  <span class='k'>var</span> <span class='nv'>$handle</span> <span class='o'>=</span> <span class='k'>null</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$server</span> <span class='o'>=</span> <span class='s1'>&#39;localhost&#39;</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$port</span> <span class='o'>=</span> <span class='s1'>&#39;9628&#39;</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$username</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$password</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$database</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span><span class='p'>;</span>

  <span class='k'>function</span> <span class='nf'>ODBCSock</span><span class='p'>(</span> <span class='nv'>$server</span><span class='p'>,</span> <span class='nv'>$user</span><span class='p'>,</span> <span class='nv'>$passwd</span><span class='p'>,</span> <span class='nv'>$database</span> <span class='o'>=</span> <span class='k'>false</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='nv'>$server</span> <span class='o'>=</span> <span class='nb'>explode</span><span class='p'>(</span><span class='s1'>&#39;:&#39;</span><span class='p'>,</span> <span class='nv'>$server</span><span class='p'>);</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nb'>count</span><span class='p'>(</span><span class='nv'>$server</span><span class='p'>)</span> <span class='o'>&gt;</span> <span class='mi'>1</span><span class='p'>)</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>port</span> <span class='o'>=</span> <span class='nb'>array_pop</span><span class='p'>(</span> <span class='nv'>$server</span> <span class='p'>);</span>
    <span class='k'>else</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>port</span> <span class='o'>=</span> <span class='mi'>9628</span><span class='p'>;</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>server</span> <span class='o'>=</span> <span class='nb'>implode</span><span class='p'>(</span><span class='s1'>&#39;:&#39;</span><span class='p'>,</span> <span class='nv'>$server</span><span class='p'>);</span>

    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>handle</span> <span class='o'>=</span> <span class='nb'>fsockopen</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>server</span><span class='p'>,</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>port</span><span class='p'>,</span> <span class='nv'>$errNo</span><span class='p'>,</span> <span class='nv'>$errStr</span><span class='p'>,</span> <span class='mi'>30</span> <span class='p'>);</span>
    <span class='k'>if</span> <span class='p'>(</span> <span class='o'>!</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>handle</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='k'>return</span> <span class='k'>null</span><span class='p'>;</span>
    <span class='p'>}</span>

    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>username</span> <span class='o'>=</span> <span class='nv'>$user</span><span class='p'>;</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>password</span> <span class='o'>=</span> <span class='nv'>$passwd</span><span class='p'>;</span>

    <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$database</span> <span class='o'>!==</span> <span class='k'>false</span><span class='p'>)</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>selectDB</span><span class='p'>(</span> <span class='nv'>$database</span> <span class='p'>);</span>
  <span class='p'>}</span>


  <span class='k'>function</span> <span class='nf'>selectDB</span><span class='p'>(</span> <span class='nv'>$database</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>database</span> <span class='o'>=</span> <span class='nv'>$database</span><span class='p'>;</span>
  <span class='p'>}</span>


  <span class='k'>function</span> <span class='o'>&amp;</span> <span class='nf'>query</span><span class='p'>(</span> <span class='nv'>$query</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='nv'>$pl</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>();</span>
    <span class='nv'>$pl</span><span class='p'>[]</span> <span class='o'>=</span> <span class='s1'>&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&#39;</span><span class='p'>;</span>
    <span class='nv'>$pl</span><span class='p'>[]</span> <span class='o'>=</span> <span class='s1'>&#39;&lt;request&gt;&#39;</span><span class='p'>;</span>
    <span class='nv'>$pl</span><span class='p'>[]</span> <span class='o'>=</span> <span class='s1'>&#39;&lt;connectionstring&gt;DSN=&#39;</span> <span class='o'>.</span> <span class='nx'>HTMLSpecialChars</span><span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>database</span><span class='p'>)</span> <span class='o'>.</span> <span class='s1'>&#39;;UID=&#39;</span> <span class='o'>.</span> <span class='nx'>HTMLSpecialChars</span><span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>username</span><span class='p'>)</span> <span class='o'>.</span> <span class='s1'>&#39;;PWD=&#39;</span> <span class='o'>.</span> <span class='nx'>HTMLSpecialChars</span><span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>password</span><span class='p'>)</span> <span class='o'>.</span> <span class='s1'>&#39;;&lt;/connectionstring&gt;&#39;</span><span class='p'>;</span>
    <span class='nv'>$pl</span><span class='p'>[]</span> <span class='o'>=</span> <span class='s1'>&#39;&lt;sql&gt;&#39;</span> <span class='o'>.</span> <span class='nx'>HTMLSpecialChars</span><span class='p'>(</span> <span class='nv'>$query</span> <span class='p'>)</span> <span class='o'>.</span> <span class='s1'>&#39;&lt;/sql&gt;&#39;</span><span class='p'>;</span>
    <span class='nv'>$pl</span><span class='p'>[]</span> <span class='o'>=</span> <span class='s1'>&#39;&lt;/request&gt;&#39;</span><span class='p'>;</span>

    <span class='nb'>fwrite</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>handle</span><span class='p'>,</span> <span class='nb'>implode</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='nv'>$pl</span><span class='p'>)</span> <span class='p'>);</span>

    <span class='nv'>$rs</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>ODBCSock_Result</span><span class='p'>(</span> <span class='nv'>$this</span> <span class='p'>);</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$rs</span><span class='o'>-&gt;</span><span class='na'>sax</span><span class='o'>-&gt;</span><span class='na'>error</span><span class='p'>)</span> <span class='k'>return</span> <span class='k'>FALSE</span><span class='p'>;</span>
    <span class='k'>else</span> <span class='k'>return</span> <span class='nv'>$rs</span><span class='p'>;</span>
  <span class='p'>}</span>
<span class='p'>}</span>


<span class='k'>class</span> <span class='nc'>ODBCSock_Result</span> <span class='p'>{</span>
  <span class='k'>var</span> <span class='nv'>$rows</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>();</span>
  <span class='k'>var</span> <span class='nv'>$conn</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$lastRow</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>

  <span class='k'>function</span> <span class='nf'>ODBCSock_Result</span><span class='p'>(</span> <span class='o'>&amp;</span><span class='nv'>$conn</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>conn</span> <span class='o'>=&amp;</span> <span class='nv'>$conn</span><span class='p'>;</span>

    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>sax</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>ODBCSock_SAX</span><span class='p'>(</span> <span class='nv'>$this</span> <span class='p'>);</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parser</span> <span class='o'>=</span> <span class='nx'>xml_parser_create</span><span class='p'>();</span>
    <span class='nx'>xml_set_object</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parser</span><span class='p'>,</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>sax</span> <span class='p'>);</span>
    <span class='nx'>xml_parser_set_option</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parser</span><span class='p'>,</span> <span class='nx'>XML_OPTION_CASE_FOLDING</span><span class='p'>,</span> <span class='k'>false</span> <span class='p'>);</span>

    <span class='nx'>xml_set_element_handler</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parser</span><span class='p'>,</span> <span class='s1'>&#39;startElement&#39;</span><span class='p'>,</span> <span class='s1'>&#39;endElement&#39;</span> <span class='p'>);</span>
    <span class='nx'>xml_set_character_data_handler</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parser</span><span class='p'>,</span> <span class='s1'>&#39;content&#39;</span> <span class='p'>);</span>

    <span class='k'>while</span> <span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>_read</span><span class='p'>()</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>sax</span><span class='o'>-&gt;</span><span class='na'>error</span> <span class='o'>||</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>sax</span><span class='o'>-&gt;</span><span class='na'>parsing</span><span class='p'>)</span>
        <span class='k'>break</span><span class='p'>;</span>
    <span class='p'>}</span>
  <span class='p'>}</span>

  <span class='k'>function</span> <span class='nf'>_eof</span><span class='p'>()</span>
  <span class='p'>{</span>
          <span class='k'>return</span> <span class='nb'>feof</span><span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>conn</span><span class='o'>-&gt;</span><span class='na'>handle</span><span class='p'>);</span>
  <span class='p'>}</span>

  <span class='k'>function</span> <span class='nf'>_read</span><span class='p'>()</span>
  <span class='p'>{</span>
          <span class='nx'>xml_parse</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parser</span><span class='p'>,</span> <span class='nb'>fread</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>conn</span><span class='o'>-&gt;</span><span class='na'>handle</span><span class='p'>,</span> <span class='mi'>4096</span> <span class='p'>),</span> <span class='nb'>feof</span><span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>conn</span><span class='o'>-&gt;</span><span class='na'>handle</span><span class='p'>)</span> <span class='p'>);</span>
  <span class='p'>}</span>

  <span class='k'>function</span> <span class='nf'>addRow</span><span class='p'>(</span> <span class='nv'>$row</span> <span class='p'>)</span>
  <span class='p'>{</span>
          <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>rows</span><span class='p'>[]</span> <span class='o'>=</span> <span class='nv'>$row</span><span class='p'>;</span>
  <span class='p'>}</span>


  <span class='k'>function</span> <span class='nf'>fetch</span><span class='p'>(</span> <span class='nv'>$row</span> <span class='o'>=</span> <span class='k'>false</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$row</span> <span class='o'>===</span> <span class='k'>false</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='nv'>$row</span> <span class='o'>=</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>lastRow</span><span class='p'>;</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>lastRow</span><span class='o'>++</span><span class='p'>;</span>
    <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>lastRow</span> <span class='o'>=</span> <span class='nv'>$row</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>;</span>
    <span class='p'>}</span>

    <span class='k'>do</span> <span class='p'>{</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>_read</span><span class='p'>();</span>

      <span class='k'>if</span> <span class='p'>(</span><span class='nb'>isset</span><span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>rows</span><span class='p'>[</span><span class='nv'>$row</span><span class='p'>]))</span>
        <span class='k'>return</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>rows</span><span class='p'>[</span><span class='nv'>$row</span><span class='p'>];</span>

    <span class='p'>}</span> <span class='k'>while</span> <span class='p'>(</span> <span class='o'>!</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>_eof</span><span class='p'>()</span> <span class='p'>);</span>
  <span class='p'>}</span>
<span class='p'>}</span>

<span class='k'>class</span> <span class='nc'>ODBCSock_SAX</span> <span class='p'>{</span>

  <span class='k'>var</span> <span class='nv'>$error</span> <span class='o'>=</span> <span class='k'>false</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$parsing</span> <span class='o'>=</span> <span class='k'>false</span><span class='p'>;</span>

  <span class='k'>var</span> <span class='nv'>$curElement</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$curColumn</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$curColumnIdx</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$curRowIdx</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>

  <span class='k'>var</span> <span class='nv'>$rs</span> <span class='o'>=</span> <span class='k'>null</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$row</span><span class='p'>;</span>
  <span class='k'>var</span> <span class='nv'>$labels</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>();</span>

  <span class='k'>function</span> <span class='nf'>ODBCSock_SAX</span>   <span class='p'>(</span> <span class='o'>&amp;</span><span class='nv'>$rs</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>rs</span> <span class='o'>=&amp;</span> <span class='nv'>$rs</span><span class='p'>;</span>
  <span class='p'>}</span>

  <span class='k'>function</span> <span class='nf'>startElement</span><span class='p'>(</span> <span class='nv'>$parser</span><span class='p'>,</span> <span class='nv'>$name</span><span class='p'>,</span> <span class='nv'>$attrs</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curElement</span> <span class='o'>=</span> <span class='nv'>$name</span><span class='p'>;</span>

    <span class='k'>if</span> <span class='p'>(</span> <span class='nv'>$name</span> <span class='o'>==</span> <span class='s1'>&#39;result&#39;</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$attrs</span><span class='p'>[</span><span class='s1'>&#39;state&#39;</span><span class='p'>]</span> <span class='o'>==</span> <span class='s1'>&#39;success&#39;</span><span class='p'>)</span>
        <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>parsing</span> <span class='o'>=</span> <span class='k'>true</span><span class='p'>;</span>
      <span class='k'>else</span>
        <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>error</span> <span class='o'>=</span> <span class='k'>true</span><span class='p'>;</span>
    <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span> <span class='nv'>$name</span> <span class='o'>==</span> <span class='s1'>&#39;row&#39;</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>row</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>();</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumnIdx</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
    <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$name</span> <span class='o'>==</span> <span class='s1'>&#39;column&#39;</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$attrs</span><span class='p'>[</span><span class='s1'>&#39;name&#39;</span><span class='p'>])</span> <span class='p'>{</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$curRowIdx</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span>
                <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>labels</span><span class='p'>[]</span> <span class='o'>=</span> <span class='nv'>$attrs</span><span class='p'>[</span><span class='s1'>&#39;name&#39;</span><span class='p'>];</span>

        <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumn</span> <span class='o'>=</span> <span class='nv'>$attrs</span><span class='p'>[</span><span class='s1'>&#39;name&#39;</span><span class='p'>];</span>
      <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
        <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumn</span> <span class='o'>=</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>labels</span><span class='p'>[</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumnIdx</span><span class='p'>];</span>
      <span class='p'>}</span>

      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>row</span><span class='p'>[</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumn</span> <span class='p'>]</span> <span class='o'>=</span> <span class='s1'>&#39;&#39;</span><span class='p'>;</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumnIdx</span><span class='o'>++</span><span class='p'>;</span>
    <span class='p'>}</span>
  <span class='p'>}</span>

  <span class='k'>function</span> <span class='nf'>endElement</span><span class='p'>(</span> <span class='nv'>$parser</span><span class='p'>,</span> <span class='nv'>$name</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='k'>if</span> <span class='p'>(</span> <span class='nv'>$name</span> <span class='o'>==</span> <span class='s1'>&#39;row&#39;</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>rs</span><span class='o'>-&gt;</span><span class='na'>addRow</span><span class='p'>(</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>row</span> <span class='p'>);</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curRowIdx</span><span class='o'>++</span><span class='p'>;</span>
    <span class='p'>}</span>
  <span class='p'>}</span>

  <span class='k'>function</span> <span class='nf'>content</span><span class='p'>(</span> <span class='nv'>$parser</span><span class='p'>,</span> <span class='nv'>$data</span> <span class='p'>)</span>
  <span class='p'>{</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curElement</span> <span class='o'>==</span> <span class='s1'>&#39;column&#39;</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>row</span><span class='p'>[</span> <span class='nv'>$this</span><span class='o'>-&gt;</span><span class='na'>curColumn</span> <span class='p'>]</span> <span class='o'>.=</span> <span class='nv'>$data</span><span class='p'>;</span>
    <span class='p'>}</span>
  <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 

  <div class="entry">
  <h2>
    
    <a href="/blog/binary-search-algorithm">The Binary Search algorithm</a>
    
  </h2>
   
  <div class="entry-meta">
    May 23, 2006
    — Filled in Code
    
      and tagged as
      webdev and javascript
    

    <a class="entry-comments" href="/blog/binary-search-algorithm/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>Long time since I last wrote here so I’ll take the opportunity to introduce (just joking) the Binary Search algorithm.</p>

<p>I was looking for a safe way to find the line of text where a user clicks the mouse. I needed this for the TextArea+ editor. Fortunately Mozilla supports the DOM3’s compareDocumentPosition() function, so I took advantatge of it. Since I’m using a UL with an LI child element for each line of text, I can say that UL.childNodes is an ordered array, which fits perfectly for the Binary Search algorithm.</p>

<p>The algorithm is really simple (I’m sure most of you have used it before), we just need to find the middle point between two points and compare its value with the one we’re looking for. We do this recursively until we either find the value or the right point becomes smaller than the left one, which means that the value is just not there.</p>

<p>Here comes a really simple example of this algorithm (without using recursive calls)</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>left</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='kd'>var</span> <span class='nx'>right</span> <span class='o'>=</span> <span class='mi'>100</span><span class='p'>;</span>

<span class='k'>while</span> <span class='p'>(</span><span class='nx'>left</span> <span class='o'>&lt;=</span> <span class='nx'>right</span><span class='p'>)</span> <span class='p'>{</span>

    <span class='nx'>middle</span> <span class='o'>=</span> <span class='nx'>floor</span><span class='p'>(</span> <span class='p'>(</span><span class='nx'>right</span><span class='o'>-</span><span class='nx'>left</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>2</span> <span class='p'>)</span> <span class='o'>+</span> <span class='nx'>left</span><span class='p'>;</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nx'>haystack</span><span class='p'>[</span><span class='nx'>mid</span><span class='p'>]</span> <span class='o'>==</span> <span class='nx'>needle</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='nx'>alert</span><span class='p'>(</span><span class='s1'>&#39;Found!&#39;</span><span class='p'>);</span>
        <span class='k'>break</span><span class='p'>;</span>
    <span class='p'>}</span>
    <span class='k'>if</span> <span class='p'>(</span> <span class='nx'>needle</span> <span class='o'>&lt;</span> <span class='nx'>haystack</span><span class='p'>[</span><span class='nx'>middle</span><span class='p'>]</span> <span class='p'>)</span>
        <span class='nx'>right</span> <span class='o'>=</span> <span class='nx'>middle</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
    <span class='k'>else</span>
        <span class='nx'>left</span> <span class='o'>=</span> <span class='nx'>middle</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div>
<p>The Binary Search algorithm performs at O(log n) time, but for TextArea+ I use a number of further optimizations. Since it’s likely that the user will click closely to where the cursor currently is, I just check the N precedding and following lines before. If this fails I check the current viewport and if still not found, then just do a full search. And this is just for the Mozilla code path! hell, how I hate cross-browser coding!</p>

<p>This post is meant to remind us how important is to learn already known and proved algorithms and that even when having a good algorithm, there is always room to optimize by taking advantge of our specific problem.</p>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 

  <div class="entry">
  <h2>
    
    <a href="/blog/programmatic-reflection-effect">Programmatic reflection effect</a>
    
  </h2>
   
  <div class="entry-meta">
    Apr 28, 2006
    — Filled in Code
    
      and tagged as
      webdev and php
    

    <a class="entry-comments" href="/blog/programmatic-reflection-effect/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>Today <a href='http://franciscovargas.net/'>Haripako</a> pointed us to <a href='http://mir.aculo.us/'>Thomas Fuchs</a> (of <a href='http://script.aculo.us/'>script.aculo.us</a> fame) <a href='http://mir.aculo.us/articles/2006/04/27/like-reflections-try-the-reflector'>DHTML image reflection effect</a></p>

<p>It uses 1px tall divs with an adjusted top offset for the containing image and the opacity property to perform it. Well, you just need to know some basic arithmetics to create this kind of effects, but I guess that if people find this kind of stuff so cool is just because most of them only do maths to check their wages :)</p>

<p>So here is some PHP to perform the same effect on the server side</p>
<div class='highlight'><pre><code class='php'><span class='cp'>&lt;?php</span>
<span class='nv'>$file</span> <span class='o'>=</span> <span class='s1'>&#39;test.png&#39;</span><span class='p'>;</span>

<span class='c1'>// Configuration params</span>
<span class='nv'>$mirrorSize</span> <span class='o'>=</span> <span class='mf'>1.35</span><span class='p'>;</span>   <span class='cm'>/* 1 .. 2 */</span>
<span class='nv'>$startAlpha</span> <span class='o'>=</span> <span class='mi'>80</span><span class='p'>;</span>     <span class='cm'>/* 0 .. 127 */</span>

<span class='c1'>// Adjust params to supported limits</span>
<span class='nv'>$mirrorSize</span> <span class='o'>=</span> <span class='nx'>max</span><span class='p'>(</span> <span class='mi'>1</span><span class='p'>,</span> <span class='nx'>min</span><span class='p'>(</span><span class='nv'>$mirrorSize</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>)</span> <span class='p'>);</span>
<span class='nv'>$startAlpha</span> <span class='o'>=</span> <span class='nx'>max</span><span class='p'>(</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>min</span><span class='p'>(</span><span class='nv'>$startAlpha</span><span class='p'>,</span> <span class='mi'>127</span><span class='p'>)</span> <span class='p'>);</span>

<span class='c1'>// Load the source file</span>
<span class='nv'>$imgSrc</span> <span class='o'>=</span> <span class='nx'>ImageCreateFromPng</span><span class='p'>(</span> <span class='nv'>$file</span> <span class='p'>);</span>

<span class='c1'>// Create the reflect portion</span>
<span class='nv'>$imgRfl</span> <span class='o'>=</span> <span class='nx'>ImageCreateTrueColor</span><span class='p'>(</span> <span class='nx'>ImagesX</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>),</span> <span class='nx'>floor</span><span class='p'>(</span><span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>)</span> <span class='o'>*</span> <span class='p'>(</span><span class='nv'>$mirrorSize</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>))</span> <span class='p'>);</span>
<span class='nx'>ImageAlphaBlending</span><span class='p'>(</span><span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='k'>true</span><span class='p'>);</span>
<span class='nx'>ImageFill</span><span class='p'>(</span> <span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span><span class='mi'>0</span><span class='p'>,</span> <span class='nx'>ImageColorAllocate</span><span class='p'>(</span> <span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='mi'>255</span><span class='p'>,</span><span class='mi'>255</span><span class='p'>,</span><span class='mi'>255</span> <span class='p'>)</span> <span class='p'>);</span>

<span class='nv'>$offset</span> <span class='o'>=</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>)</span> <span class='o'>-</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>);</span>

<span class='c1'>// In this loop we flip the source image and apply a fade out</span>
<span class='k'>for</span> <span class='p'>(</span><span class='nv'>$y</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span> <span class='nv'>$y</span> <span class='o'>&lt;</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>);</span> <span class='nv'>$y</span><span class='o'>++</span><span class='p'>)</span>
<span class='p'>{</span>
    <span class='nx'>ImageCopy</span><span class='p'>(</span> <span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='nv'>$imgSrc</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span><span class='nv'>$y</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span><span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>)</span><span class='o'>-</span><span class='nv'>$y</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>,</span> <span class='nx'>ImagesX</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>),</span> <span class='mi'>1</span> <span class='p'>);</span>
    <span class='nv'>$alpha</span> <span class='o'>=</span> <span class='nx'>floor</span><span class='p'>(</span> <span class='p'>(</span><span class='nv'>$y</span><span class='o'>*</span><span class='p'>(</span><span class='mi'>127</span><span class='o'>-</span><span class='nv'>$startAlpha</span><span class='p'>))</span> <span class='o'>/</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>)</span> <span class='p'>);</span>
    <span class='nv'>$color</span> <span class='o'>=</span> <span class='nx'>ImageColorAllocateAlpha</span><span class='p'>(</span> <span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='mi'>255</span><span class='p'>,</span><span class='mi'>255</span><span class='p'>,</span><span class='mi'>255</span><span class='p'>,</span> <span class='mi'>127</span><span class='o'>-</span><span class='nv'>$startAlpha</span><span class='o'>-</span><span class='nv'>$alpha</span> <span class='p'>);</span>
    <span class='nx'>ImageFilledRectangle</span><span class='p'>(</span> <span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nv'>$y</span><span class='p'>,</span> <span class='nx'>ImagesX</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>)</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>,</span> <span class='nv'>$y</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>,</span> <span class='nv'>$color</span> <span class='p'>);</span>
<span class='p'>}</span>

<span class='c1'>// Create the image buffer which will be outputted</span>
<span class='nv'>$imgDst</span> <span class='o'>=</span> <span class='nx'>ImageCreateTrueColor</span><span class='p'>(</span> <span class='nx'>ImagesX</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>),</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>)</span> <span class='o'>*</span> <span class='nv'>$mirrorSize</span> <span class='p'>);</span>
<span class='nx'>ImageAlphaBlending</span><span class='p'>(</span><span class='nv'>$imgDst</span><span class='p'>,</span> <span class='k'>false</span><span class='p'>);</span>

<span class='c1'>// Paste into the output buffer the original image and the reflect portion</span>
<span class='nx'>ImageCopy</span><span class='p'>(</span> <span class='nv'>$imgDst</span><span class='p'>,</span> <span class='nv'>$imgSrc</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>ImagesX</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>),</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>)</span> <span class='p'>);</span>
<span class='nx'>ImageCopy</span><span class='p'>(</span> <span class='nv'>$imgDst</span><span class='p'>,</span> <span class='nv'>$imgRfl</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>),</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>ImagesX</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>),</span> <span class='nx'>ImagesY</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>)</span> <span class='p'>);</span>

<span class='nx'>ImageDestroy</span><span class='p'>(</span> <span class='nv'>$imgSrc</span> <span class='p'>);</span>
<span class='nx'>ImageDestroy</span><span class='p'>(</span> <span class='nv'>$imgRfl</span> <span class='p'>);</span>

<span class='c1'>// Output the image</span>
<span class='nx'>header</span><span class='p'>(</span><span class='s1'>&#39;Content-type: image/png&#39;</span><span class='p'>);</span>
<span class='nx'>ImageSaveAlpha</span><span class='p'>(</span> <span class='nv'>$imgDst</span><span class='p'>,</span> <span class='k'>true</span> <span class='p'>);</span>
<span class='nx'>ImagePng</span><span class='p'>(</span> <span class='nv'>$imgDst</span> <span class='p'>);</span>

<span class='nx'>ImageDestroy</span><span class='p'>(</span> <span class='nv'>$imgDst</span> <span class='p'>);</span>
</code></pre></div>
<p>I’ve tried to keep it very simple, so it’ll only work with PNG files. Moreover it’s hardcoded for white backgrounds, althought it can be easily changed.</p>

<p>If you use this be sure to cache the result, since the cpu cycles to process images is quite high.</p>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 

  <div class="entry">
  <h2>
    
    <a href="/blog/implementing-line-based-code-editor">Implementing a line based code editor</a>
    
  </h2>
   
  <div class="entry-meta">
    Apr 06, 2006
    — Filled in Code
    
      and tagged as
      webdev and javascript
    

    <a class="entry-comments" href="/blog/implementing-line-based-code-editor/#disqus_thread"></a>
  </div>
   
  <div class="entry-content">
    
        <p>To my surprise I couldn’t find much info on the net about implementing text editors. So I had to figure it out on my own, however as often happens, while implementing it I found some info when looking for related stuff.</p>

<p>There seems to be two common ways to implement text editors, those which are line-based and those which are block-based. I started with the block-based approach, dividing the text buffer in tokens and storing the position and color attributes in each block. Soon I found that this approach gets pretty complex quite fast. So I turned the code into a line-based editor. It’s almost like the block based with the main difference that it makes an intermediate division based on lines of text. This allows to simplify the code at the expense of a bit of overhead.</p>

<p>For each line of text we need to store the actual text (or the coordinates to fetch it from a buffer), the offset relative to the start of the text, the parser state at the start of the line and block definitions for that line. Since we have broken down the text in lines, for each block we just need to store the offset relative to the start of line which contains it, the length of the block and the style of it. The following figure illustrates the whole concept.</p>

<p><img alt='Figure' src='/resources/linebased.png' /></p>

<p>To make all this work we just need a function which parses a single line of text. This function would take as arguments a string with the line of text and the parser context at the start of that line. It will return the blocks found and the parser context at the end of the line.</p>

<p>The code would roughly look like this:</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>txtLines</span> <span class='o'>=</span> <span class='nx'>split</span><span class='p'>(</span><span class='s1'>&#39;\n&#39;</span><span class='p'>,</span> <span class='nx'>text</span><span class='p'>);</span>
<span class='nx'>lines</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nb'>Array</span><span class='p'>();</span>
<span class='nx'>context</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>Context</span><span class='p'>();</span>
<span class='nx'>offset</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
<span class='k'>for</span> <span class='p'>(</span><span class='nx'>i</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='nx'>i</span> <span class='o'>&lt;</span> <span class='nx'>count</span><span class='p'>(</span><span class='nx'>txtLines</span><span class='p'>);</span> <span class='nx'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
   <span class='nx'>lines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>source</span> <span class='o'>=</span> <span class='nx'>txtLines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>];</span>
   <span class='nx'>lines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>offset</span> <span class='o'>=</span> <span class='nx'>offset</span><span class='p'>;</span>
   <span class='nx'>lines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>state</span> <span class='o'>=</span> <span class='nx'>state</span><span class='p'>;</span>
   <span class='nx'>lines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>blocks</span> <span class='o'>=</span> <span class='nx'>parseLine</span><span class='p'>(</span> <span class='nx'>txtLines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>],</span> <span class='nx'>context</span> <span class='p'>);</span>
   <span class='nx'>offset</span> <span class='o'>+=</span> <span class='nx'>strlen</span><span class='p'>(</span> <span class='nx'>txtLines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>]</span> <span class='p'>);</span>
<span class='p'>}</span>
</code></pre></div>
<p>The advantatge of the line based approach is that it’s very easy to reparse the text to display any changes on the syntax highlighting. To do so we just need to parse each line from the modified one to the end until the parser context matches</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>context</span> <span class='o'>=</span> <span class='nx'>line</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>context</span><span class='p'>;</span>
<span class='k'>do</span> <span class='p'>{</span>
   <span class='nx'>lines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>blocks</span> <span class='o'>=</span> <span class='nx'>parseLine</span><span class='p'>(</span> <span class='nx'>lines</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>text</span><span class='p'>,</span> <span class='nx'>context</span> <span class='p'>);</span>
   <span class='nx'>i</span><span class='o'>++</span><span class='p'>;</span>
<span class='p'>}</span> <span class='k'>while</span> <span class='p'>(</span> <span class='nx'>context</span> <span class='o'>!=</span> <span class='nx'>line</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>context</span> <span class='p'>);</span>
</code></pre></div>
<p>Most of the time, buffer changes will only affect a line and most lines will only be a few chars long, so we have a really optimized solution with only a few lines of code.</p>

<p>In overall, writing a fast text editor is quite simple if we only optimize for the common cases. In fact, I’m having more problems optimizing the display routines than the buffer updating ones.</p>
    
  </div>
   
  <div class="entry-footer">
  </div>
</div>
 




  <div id="pagination">
    
      <a class="prev" href="/page9/">&laquo; Newer</a>
    
  
    
      
        <a class="num" href="/">1</a>
      
    
      
        <a class="num" href="/page2/">2</a>
      
    
      
        <a class="num" href="/page3/">3</a>
      
    
      
        <a class="num" href="/page4/">4</a>
      
    
      
        <a class="num" href="/page5/">5</a>
      
    
      
        <a class="num" href="/page6/">6</a>
      
    
      
        <a class="num" href="/page7/">7</a>
      
    
      
        <a class="num" href="/page8/">8</a>
      
    
      
        <a class="num" href="/page9/">9</a>
      
    
      
        <span class="num">10</span>
      
    
      
        <a class="num" href="/page11/">11</a>
      
    
      
        <a class="num" href="/page12/">12</a>
      
    
  
    
      <a class="next" href="/page11/">Older &raquo;</a>
    
  </div>



      </div>       
    </div>
     
    <div id="footer">
      <div id="about">
        
        <p>Content is licensed under <a href="http://creativecommons.org/licenses/by/2.5/">Creative Commons Attribution 2.5</a> unless stated otherwise.
</p>
        
        <p>The opinions of authors expressed herein are those of the author and do not necessarily state or reflect those of the site owner.
</p>
        
      </div>
      <div id="copyright">
        
        <p>&copy; Copyright 2004-2010 Iván -DrSlump- Montes</p>
        
        <p>Design based on <a href="http://dezinerfolio.com/demo/darkelegance">Dark Elegance</a> by <a href="http://dezinerfolio.com">Dezinerfolio</a>
</p>
        
        <p>Published with <a href="http://jekyllrb.com">Jekyll</a></p>
        
      </div>
    </div>
     
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    
     
    

    <!-- Disqus number of comments -->
    <script type="text/javascript" defer="defer">
      (function(){
        var links = document.getElementsByTagName('a');
        var query = '?';
        for (var i=0; i<links.length; i++){
          if (links[i].href.indexOf('#disqus_thread') >= 0){
            query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
        }
        document.write('<script defer="defer" charset="utf-8" type="text/javascript" src="http://disqus.com/forums/pollinimini/get_num_replies.js' + query + '"></' + 'script>');
      })();
    </script>

    <!-- Google Analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-580032-2");
      pageTracker._trackPageview();
    } catch(err) {}
    </script>
    
  </body>
</html>
